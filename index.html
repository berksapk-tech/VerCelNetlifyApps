<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { background-color: #000; color: #fff; font-family: ui-sans-serif, system-ui; }
  .custom-shadow { box-shadow: 0 0 40px rgba(37, 99, 235, 0.15); }
  input::placeholder { color: #52525b; }
</style>

<div class="min-h-screen flex flex-col items-center p-4 pb-32">
  
  <h1 class="text-5xl font-black text-center mt-10 mb-8 italic text-blue-600 tracking-tighter">SERÄ°.IO</h1>

  <div id="auth-panel" class="w-full max-w-sm">
    <div class="bg-zinc-900 border border-zinc-800 rounded-[2.5rem] p-2 custom-shadow">
      <div class="flex mb-2">
        <button onclick="setTab('L')" id="tL" class="flex-1 py-4 font-bold border-b-2 border-blue-600 transition-all">GÄ°RÄ°Å</button>
        <button onclick="setTab('R')" id="tR" class="flex-1 py-4 font-bold opacity-40 border-b-2 border-transparent transition-all">KAYIT</button>
      </div>
      <div class="p-4 space-y-4">
        <input type="email" id="email" placeholder="E-posta" class="w-full p-4 bg-black rounded-2xl border border-zinc-800 outline-none focus:border-blue-600">
        <input type="password" id="pass" placeholder="Åifre" class="w-full p-4 bg-black rounded-2xl border border-zinc-800 outline-none focus:border-blue-600">
        <button id="auth-btn" onclick="handleAuth()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-lg active:scale-95 transition-transform">DEVAM ET</button>
      </div>
    </div>
  </div>

  <div id="game-panel" class="hidden w-full max-w-sm space-y-6">
    <div class="bg-zinc-900 border border-zinc-800 rounded-[3rem] p-10 text-center custom-shadow">
      <div id="streak-val" class="text-9xl font-black italic drop-shadow-2xl">0</div>
      <p class="text-zinc-500 text-xs mt-2 uppercase tracking-[0.4em] font-bold">GÃœNLÃœK SERÄ°</p>
      <button id="hit-btn" onclick="doHit()" class="w-full mt-8 bg-white text-black py-6 rounded-3xl font-black text-2xl active:scale-90 transition-all">ARTIR ğŸ”¥</button>
      <p id="timer" class="mt-4 text-xs font-bold text-blue-500 italic h-4"></p>
    </div>

    <div class="bg-zinc-900 border border-zinc-800 rounded-[2rem] p-6">
      <h3 class="text-[10px] font-black text-zinc-500 mb-4 tracking-widest uppercase italic">ğŸ† LÄ°DERLÄ°K TABLOSU</h3>
      <div id="lb" class="space-y-3"></div>
    </div>
    
    <button onclick="auth.signOut()" class="w-full text-zinc-700 text-[10px] font-bold uppercase tracking-widest">Ã‡IKIÅ YAP</button>
  </div>

  <div id="logs" class="fixed bottom-0 left-0 w-full bg-black/80 text-[9px] font-mono p-2 h-20 border-t border-zinc-800 overflow-y-auto z-50 text-emerald-500">
    Sistem baÅŸlatÄ±lÄ±yor...
  </div>
</div>

<script>
  // YardÄ±mcÄ± Fonksiyonlar
  const log = (m, isErr = false) => {
    const l = document.getElementById('logs');
    if (l) {
      l.innerHTML += `<div style="color:${isErr ? '#f87171' : '#10b981'}">> ${m}</div>`;
      l.scrollTop = l.scrollHeight;
    }
  };

  // YapÄ±landÄ±rma
  const fbConfig = {
    apiKey: "AIzaSyAQqqUe1Llp9HsObXxPj8aXpV6KP0lN0zM",
    authDomain: "serimiz.firebaseapp.com",
    projectId: "serimiz",
    storageBucket: "serimiz.firebasestorage.app",
    messagingSenderId: "871994610542",
    appId: "1:871994610542:web:2576a4dbe9082c23ad677f"
  };
  
  if (!firebase.apps.length) firebase.initializeApp(fbConfig);
  const auth = firebase.auth();

  const sbUrl = 'https://ntrkzdkkfqbbzbmedrwk.supabase.co';
  const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50cmt6ZGtrZnFiYnpibWVkcndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTQyMDMsImV4cCI6MjA4NjY3MDIwM30.Xh1z3TKEj7u3JP_CA_s7dgX6h6e5RTcA_3hUPR4s0mY';
  const sb = supabase.createClient(sbUrl, sbKey);

  let mode = 'L';

  function setTab(m) {
    mode = m;
    document.getElementById('tL').style.opacity = m === 'L' ? '1' : '0.4';
    document.getElementById('tL').style.borderColor = m === 'L' ? '#2563eb' : 'transparent';
    document.getElementById('tR').style.opacity = m === 'R' ? '1' : '0.4';
    document.getElementById('tR').style.borderColor = m === 'R' ? '#2563eb' : 'transparent';
    document.getElementById('auth-btn').innerText = m === 'L' ? 'GÄ°RÄ°Å YAP' : 'KAYIT OL';
  }

  async function handleAuth() {
    const e = document.getElementById('email').value.trim();
    const p = document.getElementById('pass').value;
    if (!e || !p) return log("E-posta ve ÅŸifre gir!", true);
    
    try {
      if (mode === 'L') {
        await auth.signInWithEmailAndPassword(e, p);
        log("GiriÅŸ yapÄ±ldÄ±.");
      } else {
        await auth.createUserWithEmailAndPassword(e, p);
        alert("KayÄ±t BaÅŸarÄ±lÄ±! E-postanÄ± doÄŸrula ve giriÅŸ yap.");
        setTab('L');
      }
    } catch (err) { log(err.message, true); }
  }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      document.getElementById('auth-panel').classList.add('hidden');
      document.getElementById('game-panel').classList.remove('hidden');
      log("HoÅŸ geldin: " + user.email);
      await sync(user);
      loadLB();
    } else {
      document.getElementById('auth-panel').classList.remove('hidden');
      document.getElementById('game-panel').classList.add('hidden');
    }
  });

  async function sync(u) {
    log("Veriler senkronize ediliyor...");
    let { data: p, error } = await sb.from('profiles').select('*').eq('id', u.uid).single();
    
    if (!p) {
      log("Profil oluÅŸturuluyor...");
      const { data: n } = await sb.from('profiles').upsert({
        id: u.uid,
        full_name: u.email.split('@')[0],
        streak_count: 0,
        last_pressed: new Date(0).toISOString()
      }).select().single();
      p = n;
    }
    
    if (p) {
      document.getElementById('streak-val').innerText = p.streak_count;
      const diff = (new Date() - new Date(p.last_pressed)) / (1000 * 60 * 60);
      if (diff < 24) {
        const b = document.getElementById('hit-btn');
        b.disabled = true;
        b.style.opacity = "0.2";
        b.innerText = "YARIN TEKRAR GEL";
        document.getElementById('timer').innerText = `Kalan: ${Math.floor(24 - diff)} saat`;
      }
    }
  }

  async function doHit() {
    const u = auth.currentUser;
    const b = document.getElementById('hit-btn');
    b.disabled = true;
    b.innerText = "...";

    let { data: p } = await sb.from('profiles').select('streak_count').eq('id', u.uid).single();
    const val = (p ? p.streak_count : 0) + 1;

    const { error } = await sb.from('profiles').upsert({
      id: u.uid,
      full_name: u.email.split('@')[0],
      streak_count: val,
      last_pressed: new Date().toISOString()
    });

    if (!error) {
      log("BaÅŸarÄ±lÄ±! Seri: " + val);
      location.reload();
    } else {
      log("Hata: " + error.message, true);
      b.disabled = false;
    }
  }

  async function loadLB() {
    const { data } = await sb.from('profiles').select('full_name, streak_count').order('streak_count', { ascending: false }).limit(10);
    if (data) {
      document.getElementById('lb').innerHTML = data.map((x, i) => `
        <div class="flex justify-between p-4 bg-black/40 rounded-2xl border border-zinc-800 text-xs">
          <span class="font-bold text-zinc-500">#${i + 1} <span class="text-white ml-2">${x.full_name}</span></span>
          <span class="font-black text-blue-500">${x.streak_count} ğŸ”¥</span>
        </div>
      `).join('');
    }
  }
</script>
