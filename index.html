<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { 
    background-color: #000; 
    color: #fff; 
    font-family: 'Inter', ui-sans-serif, system-ui; 
    -webkit-tap-highlight-color: transparent;
  }
  .vercel-card { background: #0a0a0a; border: 1px solid #1f1f1f; border-radius: 16px; }
  .btn-primary { background: #fff; color: #000; transition: all 0.2s; cursor: pointer; }
  .btn-primary:hover { background: #e5e5e5; }
  .blue-glow { text-shadow: 0 0 30px rgba(0, 112, 243, 0.4); }
  input { background: #000 !important; border: 1px solid #333 !important; color: white !important; }
  input:focus { border-color: #0070f3 !important; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
</style>

<div class="min-h-screen flex flex-col items-center p-6 pb-20 no-scrollbar">
  
  <div class="text-center mt-12 mb-12">
    <h1 class="text-4xl font-extrabold tracking-tighter blue-glow text-blue-500 italic">SERÄ°MÄ°Z</h1>
    <p class="text-[10px] text-zinc-600 tracking-[0.3em] font-medium mt-1">serimiz.vercel.app</p>
  </div>

  <div id="auth-panel" class="w-full max-w-sm">
    <div class="vercel-card p-2 shadow-2xl">
      <div class="flex mb-2">
        <button onclick="setTab('L')" id="tL" class="flex-1 py-4 font-bold border-b-2 border-blue-500 transition-all">GÄ°RÄ°Å</button>
        <button onclick="setTab('R')" id="tR" class="flex-1 py-4 font-bold opacity-30 border-b-2 border-transparent transition-all">KAYIT</button>
      </div>
      <div class="p-6 space-y-4">
        <input type="email" id="email" placeholder="E-posta" class="w-full p-4 rounded-xl outline-none">
        <input type="password" id="pass" placeholder="Åifre" class="w-full p-4 rounded-xl outline-none">
        <button id="auth-btn" onclick="handleAuth()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-sm tracking-widest active:scale-95 transition-all">DEVAM ET</button>
      </div>
    </div>
  </div>

  <div id="game-panel" class="hidden w-full max-w-sm space-y-6">
    <div class="vercel-card p-12 text-center relative shadow-2xl">
      <div id="streak-val" class="text-9xl font-black italic tracking-tighter">0</div>
      <p class="text-zinc-500 text-[10px] mt-4 uppercase tracking-[0.5em] font-bold">GÃœNLÃœK SERÄ°</p>
      
      <button id="hit-btn" onclick="doHit()" class="btn-primary w-full mt-10 py-5 rounded-2xl font-black text-xl active:scale-90 transition-all">SERÄ°YÄ° ARTIR ğŸ”¥</button>
      <p id="timer" class="mt-6 text-[11px] font-bold text-blue-500 italic h-4 uppercase tracking-widest"></p>
    </div>

    <div class="vercel-card p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-[10px] font-black text-zinc-500 tracking-[0.2em] uppercase">ğŸ† SIRALAMA</h3>
        <span class="text-[9px] text-blue-500 font-bold bg-blue-500/10 px-2 py-1 rounded">CANLI</span>
      </div>
      <div id="lb" class="space-y-3"></div>
    </div>
    
    <button onclick="auth.signOut()" class="w-full text-zinc-800 text-[10px] font-bold uppercase tracking-widest hover:text-white transition-colors py-4">Ã‡Ä±kÄ±ÅŸ Yap</button>
  </div>
</div>

<script>
  // Firebase & Supabase Init
  const fbConfig = {
    apiKey: "AIzaSyAQqqUe1Llp9HsObXxPj8aXpV6KP0lN0zM",
    authDomain: "serimiz.firebaseapp.com",
    projectId: "serimiz",
    storageBucket: "serimiz.firebasestorage.app",
    messagingSenderId: "871994610542",
    appId: "1:871994610542:web:2576a4dbe9082c23ad677f"
  };
  
  if (!firebase.apps.length) firebase.initializeApp(fbConfig);
  const auth = firebase.auth();

  const sbUrl = 'https://ntrkzdkkfqbbzbmedrwk.supabase.co';
  const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50cmt6ZGtrZnFiYnpibWVkcndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTQyMDMsImV4cCI6MjA4NjY3MDIwM30.Xh1z3TKEj7u3JP_CA_s7dgX6h6e5RTcA_3hUPR4s0mY';
  const sb = supabase.createClient(sbUrl, sbKey);

  let mode = 'L';

  function setTab(m) {
    mode = m;
    document.getElementById('tL').style.opacity = m === 'L' ? '1' : '0.3';
    document.getElementById('tL').style.borderColor = m === 'L' ? '#0070f3' : 'transparent';
    document.getElementById('tR').style.opacity = m === 'R' ? '1' : '0.3';
    document.getElementById('tR').style.borderColor = m === 'R' ? '#0070f3' : 'transparent';
  }

  async function handleAuth() {
    const e = document.getElementById('email').value.trim();
    const p = document.getElementById('pass').value;
    if (!e || !p) return;
    try {
      if (mode === 'L') {
        await auth.signInWithEmailAndPassword(e, p);
      } else {
        await auth.createUserWithEmailAndPassword(e, p);
        alert("KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapabilirsin.");
        setTab('L');
      }
    } catch (err) { alert(err.message); }
  }

  auth.onAuthStateChanged(async (user) => {
    if (user) {
      document.getElementById('auth-panel').classList.add('hidden');
      document.getElementById('game-panel').classList.remove('hidden');
      await sync(user);
      loadLB();
    } else {
      document.getElementById('auth-panel').classList.remove('hidden');
      document.getElementById('game-panel').classList.add('hidden');
    }
  });

  async function sync(u) {
    let { data: p } = await sb.from('profiles').select('*').eq('id', u.uid).single();
    if (!p) {
      const { data: n } = await sb.from('profiles').upsert({
        id: u.uid,
        full_name: u.email.split('@')[0],
        streak_count: 0,
        last_pressed: new Date(0).toISOString()
      }).select().single();
      p = n;
    }
    if (p) {
      document.getElementById('streak-val').innerText = p.streak_count;
      const diff = (new Date() - new Date(p.last_pressed)) / (1000 * 60 * 60);
      if (diff < 24) {
        const b = document.getElementById('hit-btn');
        b.disabled = true;
        b.style.opacity = "0.1";
        b.innerText = "YARIN GEL";
        document.getElementById('timer').innerText = `BEKLEME: ${Math.floor(24 - diff)} SAAT`;
      }
    }
  }

  async function doHit() {
    const u = auth.currentUser;
    const b = document.getElementById('hit-btn');
    b.disabled = true;
    b.innerText = "...";
    try {
      let { data: p } = await sb.from('profiles').select('streak_count').eq('id', u.uid).single();
      const val = (p ? p.streak_count : 0) + 1;
      const { error } = await sb.from('profiles').upsert({
        id: u.uid,
        full_name: u.email.split('@')[0],
        streak_count: val,
        last_pressed: new Date().toISOString()
      });
      if (!error) location.reload();
      else b.disabled = false;
    } catch (e) { b.disabled = false; }
  }

  async function loadLB() {
    const { data } = await sb.from('profiles').select('full_name, streak_count').order('streak_count', { ascending: false }).limit(20);
    if (data) {
      document.getElementById('lb').innerHTML = data.map((x, i) => `
        <div class="flex justify-between items-center p-4 bg-zinc-900/40 rounded-xl border border-zinc-800/50 text-[11px]">
          <span class="font-medium text-zinc-500">#${i + 1} <span class="text-white ml-2 font-semibold lowercase">${x.full_name}</span></span>
          <span class="font-black text-blue-500">${x.streak_count} ğŸ”¥</span>
        </div>
      `).join('');
    }
  }
</script>
